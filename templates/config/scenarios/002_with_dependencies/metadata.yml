# ğŸ¯ å¤æ‚ä¾èµ–å…³ç³»åœºæ™¯ç¤ºä¾‹
# æœ¬ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•é…ç½®å…·æœ‰å¤æ‚ä¾èµ–å…³ç³»çš„å¤šæœåŠ¡åœºæ™¯

name: "complex_dependency_test"
description: "æ¼”ç¤ºå¤æ‚æœåŠ¡ä¾èµ–å…³ç³»å’Œå¹¶å‘éƒ¨ç½²çš„ç¤ºä¾‹åœºæ™¯"
version: "1.0"
tags: ["example", "dependency", "concurrent"]
estimated_duration: 2400  # 40åˆ†é’Ÿ
dependencies: []
resource_requirements:
  min_gpu_memory: "16GB"
  min_nodes: 2
  min_memory_gb: 64
author: "Playbook Team"
created: "2025-09-18"

# ğŸš€ åˆ†å¸ƒå¼éƒ¨ç½²é…ç½® - å±•ç¤ºä¾èµ–å…³ç³»å’Œæ‰¹æ¬¡éƒ¨ç½²
deployment:
  services:
    # ğŸ“Š Batch 1: åŸºç¡€æœåŠ¡å±‚ï¼ˆæ— ä¾èµ–ï¼Œå¯å¹¶å‘éƒ¨ç½²ï¼‰
    - name: "redis"
      compose_file: "docker-compose.yml"
      nodes: ["node1"]
      depends_on: []  # æ— ä¾èµ– â†’ Batch 1
      health_check:
        enabled: true
        strategy: "basic"
        startup_timeout: 120
        startup_grace_period: 30
        check_interval: 10
        max_retries: 5
        checks:
          - type: "docker_status"
            required: true
          - type: "http_endpoint"
            required: true
            url: "http://localhost:6379/ping"
            method: "GET"
            expected_status: 200
            timeout: 5

    - name: "mysql"
      compose_file: "docker-compose.yml"
      nodes: ["node2"]
      depends_on: []  # æ— ä¾èµ– â†’ Batch 1
      health_check:
        enabled: true
        strategy: "basic"
        startup_timeout: 180
        startup_grace_period: 60
        check_interval: 15
        max_retries: 8
        checks:
          - type: "docker_status"
            required: true

    - name: "config-service"
      compose_file: "docker-compose.yml"
      nodes: ["node1"]
      depends_on: []  # æ— ä¾èµ– â†’ Batch 1
      health_check:
        enabled: true
        strategy: "basic"
        startup_timeout: 90
        startup_grace_period: 20
        check_interval: 10
        max_retries: 3

    # ğŸ“Š Batch 2: åº”ç”¨æœåŠ¡å±‚ï¼ˆä¾èµ–åŸºç¡€æœåŠ¡ï¼‰
    - name: "user-service"
      compose_file: "docker-compose.yml"
      nodes: ["node1", "node2"]
      depends_on: ["redis", "mysql"]  # ä¾èµ–Batch 1çš„æœåŠ¡ â†’ Batch 2
      health_check:
        enabled: true
        strategy: "comprehensive"
        startup_timeout: 300
        startup_grace_period: 90
        check_interval: 20
        max_retries: 5
        checks:
          - type: "docker_status"
            required: true
          - type: "http_endpoint"
            required: true
            url: "http://localhost:8001/health"
            method: "GET"
            expected_status: 200
            timeout: 10

    - name: "order-service"
      compose_file: "docker-compose.yml"
      nodes: ["node1", "node2"]
      depends_on: ["redis", "mysql"]  # ä¾èµ–Batch 1çš„æœåŠ¡ â†’ Batch 2
      health_check:
        enabled: true
        strategy: "comprehensive"
        startup_timeout: 300
        startup_grace_period: 90
        check_interval: 20
        max_retries: 5

    # ğŸ“Š Batch 3: ç½‘å…³å±‚ï¼ˆä¾èµ–åº”ç”¨æœåŠ¡ï¼‰
    - name: "api-gateway"
      compose_file: "docker-compose.yml"
      nodes: ["node1"]
      depends_on: ["user-service", "order-service", "config-service"]  # ä¾èµ–Batch 1å’Œ2 â†’ Batch 3
      health_check:
        enabled: true
        strategy: "comprehensive"
        startup_timeout: 240
        startup_grace_period: 60
        check_interval: 15
        max_retries: 8
        checks:
          - type: "docker_status"
            required: true
          - type: "http_endpoint"
            required: true
            url: "http://localhost:8080/api/health"
            method: "GET"
            expected_status: 200
            timeout: 10

    # ğŸ“Š Batch 4: å‰ç«¯å±‚ï¼ˆä¾èµ–ç½‘å…³ï¼‰
    - name: "web-frontend"
      compose_file: "docker-compose.yml"
      nodes: ["node2"]
      depends_on: ["api-gateway"]  # ä¾èµ–Batch 3 â†’ Batch 4
      health_check:
        enabled: true
        strategy: "basic"
        startup_timeout: 120
        startup_grace_period: 30
        check_interval: 10
        max_retries: 3

    - name: "mobile-app-backend"
      compose_file: "docker-compose.yml"
      nodes: ["node1"]
      depends_on: ["api-gateway"]  # ä¾èµ–Batch 3 â†’ Batch 4
      health_check:
        enabled: true
        strategy: "basic"
        startup_timeout: 120
        startup_grace_period: 30
        check_interval: 10
        max_retries: 3

# ğŸ“Š é¢„æœŸçš„å¹¶å‘éƒ¨ç½²æ‰¹æ¬¡åˆ†æï¼š
#
# Batch 1 (å¹¶å‘3ä¸ªæœåŠ¡): [redis, mysql, config-service]
# â”œâ”€ æ— ä¾èµ–ï¼Œå¯åŒæ—¶å¯åŠ¨
# â”œâ”€ éƒ¨ç½²æ—¶é—´ï¼šçº¦max(120s, 180s, 90s) = 180s
# â””â”€ å¹¶å‘åº¦ï¼š3/5 (åœ¨max_concurrent_services=5çš„é™åˆ¶ä¸‹)
#
# Batch 2 (å¹¶å‘2ä¸ªæœåŠ¡): [user-service, order-service]
# â”œâ”€ ç­‰å¾…Batch 1å®Œæˆåå¼€å§‹
# â”œâ”€ éƒ¨ç½²æ—¶é—´ï¼šçº¦max(300s, 300s) = 300s
# â””â”€ å¹¶å‘åº¦ï¼š2/5
#
# Batch 3 (1ä¸ªæœåŠ¡): [api-gateway]
# â”œâ”€ ç­‰å¾…Batch 2å®Œæˆåå¼€å§‹
# â”œâ”€ éƒ¨ç½²æ—¶é—´ï¼šçº¦240s
# â””â”€ å¹¶å‘åº¦ï¼š1/5
#
# Batch 4 (å¹¶å‘2ä¸ªæœåŠ¡): [web-frontend, mobile-app-backend]
# â”œâ”€ ç­‰å¾…Batch 3å®Œæˆåå¼€å§‹
# â”œâ”€ éƒ¨ç½²æ—¶é—´ï¼šçº¦max(120s, 120s) = 120s
# â””â”€ å¹¶å‘åº¦ï¼š2/5
#
# ğŸ¯ æ€»éƒ¨ç½²æ—¶é—´ï¼š180s + 300s + 240s + 120s = 840s (14åˆ†é’Ÿ)
# ğŸ“ˆ å¯¹æ¯”ä¸²è¡Œéƒ¨ç½²ï¼š180+300+240+120+120+90+180 = 1230s (20.5åˆ†é’Ÿ)
# ğŸš€ æ€§èƒ½æå‡ï¼šçº¦32% (èŠ‚çœ6.5åˆ†é’Ÿ)

  test_execution:
    node: "local"
    script: "run_complex_test.sh"
    timeout: 2400
    result_paths:
      - "/tmp/complex_test_results"
      - "/var/log/integration_test"
    wait_for_all_services: true
    collection_mode: "standard"  # ä½¿ç”¨æ ‡å‡†æ¨¡å¼æ”¶é›†å…¨é¢ç»“æœ