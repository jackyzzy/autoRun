# ğŸ³ å¤æ‚ä¾èµ–å…³ç³»åœºæ™¯çš„Docker Composeé…ç½®ç¤ºä¾‹
# æ³¨æ„ï¼šè¿™ä¸ªæ–‡ä»¶æ¼”ç¤ºäº†æœåŠ¡é—´çš„ä¾èµ–å…³ç³»å¦‚ä½•åœ¨Playbookä¸­å¤„ç†
# Playbookä¼šè‡ªåŠ¨æ ¹æ®metadata.ymlä¸­çš„depends_onå­—æ®µç¡®å®šéƒ¨ç½²æ‰¹æ¬¡

version: '3.8'

services:
  # ğŸ“Š Batch 1: åŸºç¡€æœåŠ¡å±‚
  redis:
    image: "redis:7-alpine"
    container_name: "demo_redis"
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  mysql:
    image: "mysql:8.0"
    container_name: "demo_mysql"
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: "demo_password"
      MYSQL_DATABASE: "demo_db"
      MYSQL_USER: "demo_user"
      MYSQL_PASSWORD: "demo_pass"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  config-service:
    image: "nginx:alpine"
    container_name: "demo_config_service"
    ports:
      - "8090:80"
    volumes:
      - ./config:/usr/share/nginx/html:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # ğŸ“Š Batch 2: åº”ç”¨æœåŠ¡å±‚ (ä¾èµ–Batch 1)
  # æ³¨æ„ï¼šDocker Composeçš„depends_onåªæ§åˆ¶å¯åŠ¨é¡ºåºï¼Œä¸ç­‰å¾…æœåŠ¡å°±ç»ª
  # Playbookçš„depends_onä¼šç­‰å¾…ä¾èµ–æœåŠ¡å®Œå…¨å°±ç»ªï¼ˆåŒ…æ‹¬å¥åº·æ£€æŸ¥ï¼‰
  user-service:
    image: "demo/user-service:latest"
    container_name: "demo_user_service"
    ports:
      - "8001:8000"
    environment:
      REDIS_URL: "redis://redis:6379"
      DATABASE_URL: "mysql://demo_user:demo_pass@mysql:3306/demo_db"
      CONFIG_SERVICE_URL: "http://config-service:80"
    # Docker Composeçš„depends_onï¼ˆå¯åŠ¨é¡ºåºä¾èµ–ï¼‰
    depends_on:
      - redis
      - mysql
      - config-service
    # Playbookçš„depends_onåœ¨metadata.ymlä¸­å®šä¹‰ï¼ˆå°±ç»ªçŠ¶æ€ä¾èµ–ï¼‰
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped

  order-service:
    image: "demo/order-service:latest"
    container_name: "demo_order_service"
    ports:
      - "8002:8000"
    environment:
      REDIS_URL: "redis://redis:6379"
      DATABASE_URL: "mysql://demo_user:demo_pass@mysql:3306/demo_db"
      USER_SERVICE_URL: "http://user-service:8000"
    depends_on:
      - redis
      - mysql
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped

  # ğŸ“Š Batch 3: ç½‘å…³å±‚ (ä¾èµ–Batch 1å’Œ2)
  api-gateway:
    image: "demo/api-gateway:latest"
    container_name: "demo_api_gateway"
    ports:
      - "8080:8080"
    environment:
      USER_SERVICE_URL: "http://user-service:8000"
      ORDER_SERVICE_URL: "http://order-service:8000"
      CONFIG_SERVICE_URL: "http://config-service:80"
    depends_on:
      - user-service
      - order-service
      - config-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 15s
      timeout: 10s
      retries: 8
      start_period: 60s
    restart: unless-stopped

  # ğŸ“Š Batch 4: å‰ç«¯å±‚ (ä¾èµ–Batch 3)
  web-frontend:
    image: "demo/web-frontend:latest"
    container_name: "demo_web_frontend"
    ports:
      - "3000:3000"
    environment:
      API_GATEWAY_URL: "http://api-gateway:8080"
    depends_on:
      - api-gateway
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  mobile-app-backend:
    image: "demo/mobile-backend:latest"
    container_name: "demo_mobile_backend"
    ports:
      - "8003:8000"
    environment:
      API_GATEWAY_URL: "http://api-gateway:8080"
    depends_on:
      - api-gateway
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

# ğŸ’¾ æ•°æ®æŒä¹…åŒ–
volumes:
  redis_data:
    driver: local
  mysql_data:
    driver: local

# ğŸŒ ç½‘ç»œé…ç½®
networks:
  default:
    name: demo_network
    driver: bridge

# ğŸ“ é‡è¦è¯´æ˜ï¼š
#
# ğŸ”„ ä¾èµ–å…³ç³»çš„ä¸¤ä¸ªå±‚é¢ï¼š
# 1. Docker Compose depends_on: æ§åˆ¶å®¹å™¨å¯åŠ¨é¡ºåºï¼Œä½†ä¸ç­‰å¾…æœåŠ¡å°±ç»ª
# 2. Playbook depends_on: ç­‰å¾…æœåŠ¡å®Œå…¨å°±ç»ªï¼ˆå¥åº·æ£€æŸ¥é€šè¿‡ï¼‰åæ‰å¯åŠ¨ä¾èµ–æ–¹
#
# ğŸš€ å¹¶å‘éƒ¨ç½²çš„ä¼˜åŠ¿ï¼š
# - ä¼ ç»Ÿæ–¹å¼ï¼šé€ä¸ªå¯åŠ¨æœåŠ¡ï¼Œæ€»æ—¶é—´ = æ‰€æœ‰æœåŠ¡å¯åŠ¨æ—¶é—´ä¹‹å’Œ
# - å¹¶å‘æ–¹å¼ï¼šæ‰¹æ¬¡å†…å¹¶å‘ï¼Œæ€»æ—¶é—´ = å„æ‰¹æ¬¡æœ€å¤§å¯åŠ¨æ—¶é—´ä¹‹å’Œ
#
# ğŸ¯ æœ€ä½³å®è·µï¼š
# 1. åˆç†è®¾è®¡æœåŠ¡ä¾èµ–å…³ç³»ï¼Œé¿å…è¿‡æ·±çš„ä¾èµ–é“¾
# 2. åŸºç¡€æœåŠ¡ï¼ˆredisã€mysqlï¼‰å°½é‡æ— ä¾èµ–ï¼Œå¯ä»¥å¹¶å‘å¯åŠ¨
# 3. åº”ç”¨æœåŠ¡å±‚å¯ä»¥ä¾èµ–åŸºç¡€æœåŠ¡ï¼Œåœ¨åŒä¸€æ‰¹æ¬¡å†…å¹¶å‘
# 4. ç½‘å…³å’Œå‰ç«¯æœåŠ¡ä¾èµ–åº”ç”¨æœåŠ¡ï¼Œå½¢æˆæ¸…æ™°çš„åˆ†å±‚æ¶æ„