# ğŸ³ å¤æ‚ä¾èµ–å…³ç³»åœºæ™¯çš„Docker Composeé…ç½®ç¤ºä¾‹
# æ³¨æ„ï¼šè¿™ä¸ªæ–‡ä»¶æ¼”ç¤ºäº†æœåŠ¡é—´çš„ä¾èµ–å…³ç³»å¦‚ä½•åœ¨Playbookä¸­å¤„ç†
# Playbookä¼šè‡ªåŠ¨æ ¹æ®metadata.ymlä¸­çš„depends_onå­—æ®µç¡®å®šéƒ¨ç½²æ‰¹æ¬¡

version: '3.8'

services:
  # ğŸ“Š Batch 1: åŸºç¡€æœåŠ¡å±‚
  redis:
    image: "${REDIS_IMAGE}:${REDIS_TAG}"
    container_name: "${REDIS_CONTAINER_NAME}"
    ports:
      - "${REDIS_HOST_PORT}:${REDIS_CONTAINER_PORT}"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  mysql:
    image: "${MYSQL_IMAGE}:${MYSQL_TAG}"
    container_name: "${MYSQL_CONTAINER_NAME}"
    ports:
      - "${MYSQL_HOST_PORT}:${MYSQL_CONTAINER_PORT}"
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${MYSQL_DATABASE}"
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  config-service:
    image: "${CONFIG_SERVICE_IMAGE}:${CONFIG_SERVICE_TAG}"
    container_name: "${CONFIG_SERVICE_CONTAINER_NAME}"
    ports:
      - "${CONFIG_SERVICE_HOST_PORT}:${CONFIG_SERVICE_CONTAINER_PORT}"
    volumes:
      - ./config:/usr/share/nginx/html:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # ğŸ“Š Batch 2: åº”ç”¨æœåŠ¡å±‚ (ä¾èµ–Batch 1)
  # æ³¨æ„ï¼šDocker Composeçš„depends_onåªæ§åˆ¶å¯åŠ¨é¡ºåºï¼Œä¸ç­‰å¾…æœåŠ¡å°±ç»ª
  # Playbookçš„depends_onä¼šç­‰å¾…ä¾èµ–æœåŠ¡å®Œå…¨å°±ç»ªï¼ˆåŒ…æ‹¬å¥åº·æ£€æŸ¥ï¼‰
  user-service:
    image: "${USER_SERVICE_IMAGE}:${USER_SERVICE_TAG}"
    container_name: "${USER_SERVICE_CONTAINER_NAME}"
    ports:
      - "${USER_SERVICE_HOST_PORT}:${USER_SERVICE_CONTAINER_PORT}"
    environment:
      REDIS_URL: "${REDIS_URL}"
      DATABASE_URL: "${DATABASE_URL}"
      CONFIG_SERVICE_URL: "${CONFIG_SERVICE_URL}"
    # Docker Composeçš„depends_onï¼ˆå¯åŠ¨é¡ºåºä¾èµ–ï¼‰
    depends_on:
      - redis
      - mysql
      - config-service
    # Playbookçš„depends_onåœ¨metadata.ymlä¸­å®šä¹‰ï¼ˆå°±ç»ªçŠ¶æ€ä¾èµ–ï¼‰
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped

  order-service:
    image: "${ORDER_SERVICE_IMAGE}:${ORDER_SERVICE_TAG}"
    container_name: "${ORDER_SERVICE_CONTAINER_NAME}"
    ports:
      - "${ORDER_SERVICE_HOST_PORT}:${ORDER_SERVICE_CONTAINER_PORT}"
    environment:
      REDIS_URL: "${REDIS_URL}"
      DATABASE_URL: "${DATABASE_URL}"
      USER_SERVICE_URL: "${USER_SERVICE_URL}"
    depends_on:
      - redis
      - mysql
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped

  # ğŸ“Š Batch 3: ç½‘å…³å±‚ (ä¾èµ–Batch 1å’Œ2)
  api-gateway:
    image: "${API_GATEWAY_IMAGE}:${API_GATEWAY_TAG}"
    container_name: "${API_GATEWAY_CONTAINER_NAME}"
    ports:
      - "${API_GATEWAY_HOST_PORT}:${API_GATEWAY_CONTAINER_PORT}"
    environment:
      USER_SERVICE_URL: "${USER_SERVICE_URL}"
      ORDER_SERVICE_URL: "${ORDER_SERVICE_URL}"
      CONFIG_SERVICE_URL: "${CONFIG_SERVICE_URL}"
    depends_on:
      - user-service
      - order-service
      - config-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 15s
      timeout: 10s
      retries: 8
      start_period: 60s
    restart: unless-stopped

  # ğŸ“Š Batch 4: å‰ç«¯å±‚ (ä¾èµ–Batch 3)
  web-frontend:
    image: "${WEB_FRONTEND_IMAGE}:${WEB_FRONTEND_TAG}"
    container_name: "${WEB_FRONTEND_CONTAINER_NAME}"
    ports:
      - "${WEB_FRONTEND_HOST_PORT}:${WEB_FRONTEND_CONTAINER_PORT}"
    environment:
      API_GATEWAY_URL: "${API_GATEWAY_URL}"
    depends_on:
      - api-gateway
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  mobile-app-backend:
    image: "${MOBILE_BACKEND_IMAGE}:${MOBILE_BACKEND_TAG}"
    container_name: "${MOBILE_BACKEND_CONTAINER_NAME}"
    ports:
      - "${MOBILE_BACKEND_HOST_PORT}:${MOBILE_BACKEND_CONTAINER_PORT}"
    environment:
      API_GATEWAY_URL: "${API_GATEWAY_URL}"
    depends_on:
      - api-gateway
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

# ğŸ’¾ æ•°æ®æŒä¹…åŒ–
volumes:
  redis_data:
    driver: local
  mysql_data:
    driver: local

# ğŸŒ ç½‘ç»œé…ç½®
networks:
  default:
    name: ${NETWORK_NAME}
    driver: bridge

# ğŸ“ é‡è¦è¯´æ˜ï¼š
#
# ğŸ”„ ä¾èµ–å…³ç³»çš„ä¸¤ä¸ªå±‚é¢ï¼š
# 1. Docker Compose depends_on: æ§åˆ¶å®¹å™¨å¯åŠ¨é¡ºåºï¼Œä½†ä¸ç­‰å¾…æœåŠ¡å°±ç»ª
# 2. Playbook depends_on: ç­‰å¾…æœåŠ¡å®Œå…¨å°±ç»ªï¼ˆå¥åº·æ£€æŸ¥é€šè¿‡ï¼‰åæ‰å¯åŠ¨ä¾èµ–æ–¹
#
# ğŸš€ å¹¶å‘éƒ¨ç½²çš„ä¼˜åŠ¿ï¼š
# - ä¼ ç»Ÿæ–¹å¼ï¼šé€ä¸ªå¯åŠ¨æœåŠ¡ï¼Œæ€»æ—¶é—´ = æ‰€æœ‰æœåŠ¡å¯åŠ¨æ—¶é—´ä¹‹å’Œ
# - å¹¶å‘æ–¹å¼ï¼šæ‰¹æ¬¡å†…å¹¶å‘ï¼Œæ€»æ—¶é—´ = å„æ‰¹æ¬¡æœ€å¤§å¯åŠ¨æ—¶é—´ä¹‹å’Œ
#
# ğŸ¯ æœ€ä½³å®è·µï¼š
# 1. åˆç†è®¾è®¡æœåŠ¡ä¾èµ–å…³ç³»ï¼Œé¿å…è¿‡æ·±çš„ä¾èµ–é“¾
# 2. åŸºç¡€æœåŠ¡ï¼ˆredisã€mysqlï¼‰å°½é‡æ— ä¾èµ–ï¼Œå¯ä»¥å¹¶å‘å¯åŠ¨
# 3. åº”ç”¨æœåŠ¡å±‚å¯ä»¥ä¾èµ–åŸºç¡€æœåŠ¡ï¼Œåœ¨åŒä¸€æ‰¹æ¬¡å†…å¹¶å‘
# 4. ç½‘å…³å’Œå‰ç«¯æœåŠ¡ä¾èµ–åº”ç”¨æœåŠ¡ï¼Œå½¢æˆæ¸…æ™°çš„åˆ†å±‚æ¶æ„